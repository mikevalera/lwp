#!/bin/bash
#
# lwp - Local WP-CLI wrapper
# Run WP-CLI commands against any Local by Flywheel site without entering site shell.
# Automatically resolves site from current directory or --site flag.
#
# Copyright (c) 2025 Mike Valera
# Licensed under the MIT License. See LICENSE file for details.
#
# Usage:
#   lwp [wp-cli command]              # auto-detect site from cwd
#   lwp --site=NAME [wp-cli command]  # target a specific site by folder name
#   lwp --list                        # list all running sites
#   lwp --list-all                    # list all sites (running and stopped)
#

set -euo pipefail

LOCAL_DATA="$HOME/Library/Application Support/Local"
SITES_JSON="$LOCAL_DATA/sites.json"
LIGHTNING="$LOCAL_DATA/lightning-services"
RUN_DIR="$LOCAL_DATA/run"
SITES_DIR="$HOME/Local Sites"
WP_CLI=$(command -v wp 2>/dev/null || echo "/usr/local/bin/wp")

VERSION="1.0.1"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

show_help() {
    echo "lwp - Local WP-CLI wrapper"
    echo ""
    echo "Usage:"
    echo "  lwp [wp-cli args]              Auto-detect site from current directory"
    echo "  lwp --site=NAME [wp-cli args]  Target site by Local Sites folder name"
    echo "  lwp --list                     List running sites"
    echo "  lwp --list-all                 List all sites"
    echo "  lwp --version                  Show version"
    echo "  lwp --help                     Show this help"
    echo ""
    echo "Examples:"
    echo "  cd ~/Local Sites/mysite && lwp plugin list"
    echo "  lwp --site=mysite option get siteurl"
    echo "  lwp --site=mysite db export backup.sql"
}

# Parse sites.json and return site info as: id|name|path|domain|php_version|mysql_version
get_all_sites() {
    python3 - "$SITES_JSON" <<'PYEOF'
import json, os, sys
with open(sys.argv[1]) as f:
    sites = json.load(f)
for sid, s in sites.items():
    path = s.get('path','').replace('~', os.path.expanduser('~'))
    php = s.get('services',{}).get('php',{}).get('version','')
    mysql_ver = s.get('services',{}).get('mysql',{}).get('version','')
    folder = os.path.basename(path)
    domain = s.get('domain','')
    name = s.get('name','')
    print(f'{sid}|{name}|{folder}|{path}|{domain}|{php}|{mysql_ver}')
PYEOF
}

# Check if a site is running (socket exists AND MySQL is actually responding)
is_running() {
    local site_id="$1"
    local sock="$RUN_DIR/$site_id/mysql/mysqld.sock"
    # Quick check: socket file must exist
    [ -S "$sock" ] || return 1
    # Verify MySQL is actually alive by poking the socket
    perl -e '
        use IO::Socket::UNIX;
        my $sock = IO::Socket::UNIX->new(Peer => $ARGV[0], Type => SOCK_STREAM, Timeout => 1);
        exit($sock ? 0 : 1);
    ' "$sock" 2>/dev/null
}

# List sites
list_sites() {
    local show_all="${1:-false}"
    printf "${CYAN}%-20s %-25s %-15s %-10s${NC}\n" "FOLDER" "DOMAIN" "PHP" "STATUS"
    printf "%-20s %-25s %-15s %-10s\n" "------" "------" "---" "------"
    while IFS='|' read -r id name folder path domain php mysql_ver; do
        local running=false
        if is_running "$id"; then
            running=true
        fi
        if [ "$show_all" = "true" ] || [ "$running" = "true" ]; then
            if [ "$running" = "true" ]; then
                status="${GREEN}running${NC}"
            else
                status="${RED}stopped${NC}"
            fi
            printf "%-20s %-25s %-15s ${status}\n" "$folder" "$domain" "$php"
        fi
    done < <(get_all_sites)
}

# Resolve site from current directory
resolve_from_cwd() {
    local cwd="$PWD"
    # Check if we're inside a Local Sites directory
    if [[ "$cwd" == "$SITES_DIR"/* ]]; then
        # Extract the site folder name (first directory component after Local Sites)
        local rel="${cwd#$SITES_DIR/}"
        echo "${rel%%/*}"
        return 0
    fi
    return 1
}

# Get site config by folder name, returns: id|php_version|mysql_version|path
get_site_config() {
    local target_folder="$1"
    while IFS='|' read -r id name folder path domain php mysql_ver; do
        if [ "$folder" = "$target_folder" ]; then
            echo "$id|$php|$mysql_ver|$path"
            return 0
        fi
    done < <(get_all_sites)
    return 1
}

# Find the best matching binary version from lightning-services
find_binary_dir() {
    local service="$1"  # php or mysql
    local version="$2"  # e.g. 8.3.23

    # Try exact match first (with any patch suffix)
    local match
    match=$(ls -d "$LIGHTNING/${service}-${version}+"* 2>/dev/null | sort -V | tail -1)
    if [ -n "$match" ]; then
        echo "$match"
        return 0
    fi

    # Try without patch version
    local major_minor="${version%.*}"
    match=$(ls -d "$LIGHTNING/${service}-${major_minor}."* 2>/dev/null | sort -V | tail -1)
    if [ -n "$match" ]; then
        echo "$match"
        return 0
    fi

    return 1
}

# Detect architecture
get_arch() {
    local arch
    arch=$(uname -m)
    case "$arch" in
        arm64) echo "darwin-arm64" ;;
        x86_64) echo "darwin" ;;
        *) echo "darwin" ;;
    esac
}

# Main
main() {
    # Handle flags
    local site_folder=""
    local wp_args=()

    for arg in "$@"; do
        case "$arg" in
            --version|-v)
                echo "lwp $VERSION"
                exit 0
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            --list)
                list_sites false
                exit 0
                ;;
            --list-all)
                list_sites true
                exit 0
                ;;
            --site=*)
                site_folder="${arg#--site=}"
                ;;
            *)
                wp_args+=("$arg")
                ;;
        esac
    done

    # Resolve site
    if [ -z "$site_folder" ]; then
        site_folder=$(resolve_from_cwd) || {
            echo -e "${RED}Error:${NC} Could not determine site from current directory." >&2
            echo "Either cd into a Local Sites directory or use --site=NAME" >&2
            exit 1
        }
    fi

    # Get site config
    local config
    config=$(get_site_config "$site_folder") || {
        echo -e "${RED}Error:${NC} Site folder '$site_folder' not found in Local." >&2
        echo "Use 'lwp --list-all' to see available sites." >&2
        exit 1
    }

    IFS='|' read -r site_id php_ver mysql_ver site_path <<< "$config"

    # Check if site is running
    if ! is_running "$site_id"; then
        echo -e "${RED}Error:${NC} Site '$site_folder' is not running. Start it in Local first." >&2
        exit 1
    fi

    # Resolve binary paths
    local arch
    arch=$(get_arch)

    local php_base
    php_base=$(find_binary_dir "php" "$php_ver") || {
        echo -e "${RED}Error:${NC} PHP $php_ver binaries not found in lightning-services." >&2
        exit 1
    }
    local php_bin_dir="$php_base/bin/$arch/bin"

    local mysql_base
    mysql_base=$(find_binary_dir "mysql" "$mysql_ver") || {
        echo -e "${RED}Error:${NC} MySQL $mysql_ver binaries not found in lightning-services." >&2
        exit 1
    }
    local mysql_bin_dir="$mysql_base/bin/$arch/bin"

    # Socket path
    local socket="$RUN_DIR/$site_id/mysql/mysqld.sock"

    # WordPress path
    local wp_path="$site_path/app/public"

    # Build and execute the wp-cli command
    # MYSQL_UNIX_PORT tells mysqldump/mysql binaries which socket to use
    # (needed for `wp db export`, `wp db import`, etc.)
    PATH="$php_bin_dir:$mysql_bin_dir:$PATH" \
    MYSQL_UNIX_PORT="$socket" \
    exec php \
        -d "mysqli.default_socket=$socket" \
        -d "memory_limit=512M" \
        "$WP_CLI" \
        --path="$wp_path" \
        "${wp_args[@]}"
}

main "$@"
